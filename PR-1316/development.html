

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Developer documentation &mdash; msprime 0.1.dev1 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/jupyter-sphinx.css" type="text/css" />
  <link rel="stylesheet" href="_static/thebelab.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="_static/thebelab-helper.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Citing msprime" href="CITATION.html" />
    <link rel="prev" title="Command line interface" href="cli.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> msprime
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="ancestry.html">Ancestry</a></li>
<li class="toctree-l1"><a class="reference internal" href="mutations.html">Mutations</a></li>
<li class="toctree-l1"><a class="reference internal" href="demography.html">Demography</a></li>
<li class="toctree-l1"><a class="reference internal" href="likelihoods.html">Likelihoods</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickref.html">API quick reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="utilities.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command line interface</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#quickstart">Quickstart</a></li>
<li class="toctree-l2"><a class="reference internal" href="#continuous-integration-tests">Continuous integration tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#high-level-python">High-level Python</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#conventions">Conventions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#packaging">Packaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tests">Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interfacing-with-low-level-module">Interfacing with low-level module</a></li>
<li class="toctree-l3"><a class="reference internal" href="#command-line-interfaces">Command line interfaces</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#c-library">C Library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#toolchain">Toolchain</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compiling">Compiling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#development-cli">Development CLI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#unit-tests">Unit Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code-style">Code Style</a></li>
<li class="toctree-l3"><a class="reference internal" href="#coding-conventions">Coding conventions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#error-handling">Error handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-valgrind">Running valgrind</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#python-c-interface">Python C Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="#statistical-tests">Statistical tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#benchmarking">Benchmarking</a></li>
<li class="toctree-l2"><a class="reference internal" href="#containerization">Containerization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id4">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="CITATION.html">Citing msprime</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">PORTING IN PROGRESS: Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">PORTING IN PROGRESS: API</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">msprime</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Developer documentation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/development.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="developer-documentation">
<span id="sec-development"></span><h1>Developer documentation<a class="headerlink" href="#developer-documentation" title="Permalink to this headline">¶</a></h1>
<p>If you would like to add some features to <code class="docutils literal notranslate"><span class="pre">msprime</span></code>, please read the
following. If you think there is anything missing,
please open an <a class="reference external" href="http://github.com/tskit-dev/msprime/issues">issue</a> or
<a class="reference external" href="http://github.com/tskit-dev/msprime/pulls">pull request</a> on GitHub!</p>
<div class="section" id="quickstart">
<h2>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Make a fork of the msprime repo on <a class="reference external" href="http://github.com/tskit-dev/msprime">GitHub</a></p></li>
<li><p>Clone your fork into a local directory, making sure that the <strong>submodules
are correctly initialised</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone git@github.com:tskit-dev/msprime.git --recurse-submodules
</pre></div>
</div>
<p>For an already checked out repo, the submodules can be initialised using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git submodule update --init --recursive
</pre></div>
</div>
</li>
<li><p>Install the <a class="reference internal" href="installation.html#sec-installation-system-requirements"><span class="std std-ref">basic requirements</span></a>.</p></li>
<li><p>Install the Python development requirements using <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-r</span> <span class="pre">requirements/development.txt</span></code>.</p></li>
<li><p>Build the low level module by running <code class="docutils literal notranslate"><span class="pre">make</span></code> in the project root.</p></li>
<li><p>Run the tests to ensure everything has worked: <code class="docutils literal notranslate"><span class="pre">python3</span> <span class="pre">-m</span> <span class="pre">pytest</span></code>. These should
all pass.</p></li>
<li><p>Install the pre-commit checks: <code class="docutils literal notranslate"><span class="pre">pre-commit</span> <span class="pre">install</span></code></p></li>
<li><p>Make your changes in a local branch. On each commit a <a class="reference external" href="https://pre-commit.com/">pre-commit hook</a>  will run
checks for code style and common problems.
Sometimes these will report “files were modified by this hook” <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">add</span></code>
and <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">--amend</span></code> will update the commit with the automatically modified
version.
The modifications made are for consistency, code readability and designed to
minimise merge conflicts. They are guaranteed not to modify the functionality of the
code. To run the checks without committing use <code class="docutils literal notranslate"><span class="pre">pre-commit</span> <span class="pre">run</span></code>. To bypass
the checks (to save or get feedback on work-in-progress) use <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span>
<span class="pre">--no-verify</span></code></p></li>
<li><p>If you have modifed the C code then
<code class="docutils literal notranslate"><span class="pre">clang-format</span> <span class="pre">-i</span> <span class="pre">lib/tests/*</span> <span class="pre">lib/!(avl).{c,h}</span></code> will format the code to
satisfy CI checks.</p></li>
<li><p>When ready open a pull request on GitHub. Please make sure that the tests pass before
you open the PR, unless you want to ask the community for help with a failing test.</p></li>
<li><p>See the <a class="reference external" href="https://tskit.readthedocs.io/en/latest/development.html#github-workflow">tskit documentation</a>
for more details on the recommended GitHub workflow.</p></li>
</ul>
</div>
<div class="section" id="continuous-integration-tests">
<h2>Continuous integration tests<a class="headerlink" href="#continuous-integration-tests" title="Permalink to this headline">¶</a></h2>
<p>Two different continuous integration providers are used, which run different
combinations of tests on different platforms:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://help.github.com/en/actions">Github actions</a> run a variety of code style and
quality checks using <a class="reference external" href="https://pre-commit.com/">pre-commit</a> along
with Python tests on Linux, OSX and Windows. The docs are also built and a preview
generated if changes are detected.</p></li>
<li><p><a class="reference external" href="https://circleci.com/">CircleCI</a> Runs all Python tests using the apt-get
infrastructure for system requirements. Additionally, the low-level tests
are run, coverage statistics calculated using <a class="reference external" href="https://codecov.io/gh">CodeCov</a>,
and the documentation built.</p></li>
</ol>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>There are three main parts of <code class="docutils literal notranslate"><span class="pre">msprime</span></code>, in increasing order of complexity:</p>
<ol class="arabic simple">
<li><p>High-level Python. The Python-API and command line interface tools are all defined
in the <code class="docutils literal notranslate"><span class="pre">msprime</span></code> directory.</p></li>
<li><p>C library. The underlying high-performance C code is written as a standalone library.
All of the code for this library is in the <code class="docutils literal notranslate"><span class="pre">lib</span></code> directory.</p></li>
<li><p>Low-level Python-C interface. The interface between the Python and C code is the
<code class="docutils literal notranslate"><span class="pre">msprime/_msprimemodule.c</span></code> file, which defines the <code class="docutils literal notranslate"><span class="pre">msprime._msprime</span></code> module.</p></li>
</ol>
<p>Each of these aspects has its own coding conventions and development tools, which are
documented in the following sections.</p>
</div>
<div class="section" id="high-level-python">
<h2>High-level Python<a class="headerlink" href="#high-level-python" title="Permalink to this headline">¶</a></h2>
<p>Throughout this document, we assume that the <code class="docutils literal notranslate"><span class="pre">msprime</span></code> package is built and
run locally <em>within</em> the project directory. That is, <code class="docutils literal notranslate"><span class="pre">msprime</span></code> is <em>not</em> installed
into the Python installation using <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-e</span></code> or setuptools <a class="reference external" href="http://setuptools.readthedocs.io/en/latest/setuptools.html#id23">development
mode</a>. Please
ensure that you build the low-level module using (e.g.) <code class="docutils literal notranslate"><span class="pre">make</span></code> and that
the shared object file is in the <code class="docutils literal notranslate"><span class="pre">msprime</span></code> directory. This will have a name
like <code class="docutils literal notranslate"><span class="pre">_msprime.cpython-38-x86_64-linux-gnu.so</span></code>, depending on your platform
and Python version.</p>
<div class="section" id="conventions">
<h3>Conventions<a class="headerlink" href="#conventions" title="Permalink to this headline">¶</a></h3>
<p>All Python code follows the <a class="reference external" href="https://www.python.org/dev/peps/pep-0008/">PEP8</a> style
guide, and is checked using the <a class="reference external" href="http://flake8.pycqa.org/en/latest/">flake8</a>  tool as
part of the continuous integration tests. <a class="reference external" href="https://github.com/psf/black">Black</a> is
used as part of the pre-commit hook for python code style and formatting.</p>
</div>
<div class="section" id="packaging">
<h3>Packaging<a class="headerlink" href="#packaging" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">msprime</span></code> is packaged and distributed as Python module, and follows the current
<a class="reference external" href="http://packaging.python.org">best-practices</a> advocated by the
<a class="reference external" href="http://pypa.io/en/latest/">Python Packaging Authority</a>. The primary means of
distribution is though <a class="reference external" href="http://pypi.python.org/pypi/msprime">PyPI</a>, which provides the
canonical source for each release.</p>
<p>A package for <a class="reference external" href="http://conda.io/docs/">conda</a> is also available on
<a class="reference external" href="https://github.com/conda-forge/msprime-feedstock">conda-forge</a>.</p>
</div>
<div class="section" id="tests">
<h3>Tests<a class="headerlink" href="#tests" title="Permalink to this headline">¶</a></h3>
<p>The tests for the high-level code are in the <code class="docutils literal notranslate"><span class="pre">tests</span></code> directory, and run using
<a class="reference external" href="https://docs.pytest.org/en/stable/">pytest</a>. A lot of the simulation and basic
tests are contained in the <code class="docutils literal notranslate"><span class="pre">tests/test_highlevel.py</span></code> file, but more recently
smaller test files with more focussed tests are preferred (e.g., <code class="docutils literal notranslate"><span class="pre">test_vcf.py</span></code>,
<code class="docutils literal notranslate"><span class="pre">test_demography.py</span></code>).</p>
<p>All new code must have high test coverage, which will be checked as part of the
continuous integration tests by <a class="reference external" href="https://codecov.io/gh/tskit-dev/msprime/">CodeCov</a>.</p>
</div>
<div class="section" id="interfacing-with-low-level-module">
<h3>Interfacing with low-level module<a class="headerlink" href="#interfacing-with-low-level-module" title="Permalink to this headline">¶</a></h3>
<p>Much of the high-level Python code only exists to provide a simpler interface to
the low-level <code class="docutils literal notranslate"><span class="pre">_msprime</span></code> module. As such, many objects (such as <code class="docutils literal notranslate"><span class="pre">RecombinationMap</span></code>)
are really just a shallow layer on top of the corresponding low-level object.
The convention here is to keep a reference to the low-level object via
a private instance variable such as <code class="docutils literal notranslate"><span class="pre">self._ll_recombination_map</span></code>.</p>
</div>
<div class="section" id="command-line-interfaces">
<h3>Command line interfaces<a class="headerlink" href="#command-line-interfaces" title="Permalink to this headline">¶</a></h3>
<p>The command line interfaces for <code class="docutils literal notranslate"><span class="pre">msprime</span></code> are defined in the <code class="docutils literal notranslate"><span class="pre">msprime/cli.py</span></code> file.
Each CLI has a single entry point (e.g. <code class="docutils literal notranslate"><span class="pre">msp_main</span></code>) which is invoked to run the
program. These entry points are registered with <code class="docutils literal notranslate"><span class="pre">setuptools</span></code> using the
<code class="docutils literal notranslate"><span class="pre">console_scripts</span></code> argument in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>, which allows them to be deployed as
first-class executable programs in a cross-platform manner.</p>
<p>There are simple scripts in the root of the project (currently: <code class="docutils literal notranslate"><span class="pre">msp_dev.py</span></code>,
<code class="docutils literal notranslate"><span class="pre">mspms_dev.py</span></code>) which are used for development. For example, to run the
development version of <code class="docutils literal notranslate"><span class="pre">mspms</span></code> use <code class="docutils literal notranslate"><span class="pre">python3</span> <span class="pre">mspms_dev.py</span></code>.</p>
</div>
</div>
<div class="section" id="c-library">
<h2>C Library<a class="headerlink" href="#c-library" title="Permalink to this headline">¶</a></h2>
<p>The low-level code for <code class="docutils literal notranslate"><span class="pre">msprime</span></code> is written in C, and is structured as a
standalone library. This code is all contained in the <code class="docutils literal notranslate"><span class="pre">lib</span></code> directory.
Although the code is structured as a library, it is not intended to be used
outside of the <code class="docutils literal notranslate"><span class="pre">msprime</span></code> project! The interfaces at the C level change
considerably over time, and are deliberately undocumented.</p>
<div class="section" id="toolchain">
<h3>Toolchain<a class="headerlink" href="#toolchain" title="Permalink to this headline">¶</a></h3>
<p>To compile and develop the C code, a few extra development libraries are needed.
<a class="reference external" href="http://www.hyperrealm.com/libconfig/">Libconfig</a> is used for the development CLI
and <a class="reference external" href="http://cunit.sourceforge.net">CUnit</a> for unit tests. We use the
<a class="reference external" href="https://mesonbuild.com">meson</a> build system in conjunction with <a class="reference external" href="ninja-build.org">ninja-build</a> to to compile the unit tests and
development CLI. On Debian/Ubuntu, these can be installed using</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo apt-get install libcunit1-dev libconfig-dev ninja-build
</pre></div>
</div>
<p>Meson is best installed via <code class="docutils literal notranslate"><span class="pre">pip</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python3 -m pip install meson --user
</pre></div>
</div>
<p>On macOS rather than use <code class="docutils literal notranslate"><span class="pre">apt-get</span></code> for installation of these requirements
a combination of <code class="docutils literal notranslate"><span class="pre">homebrew</span></code> and <code class="docutils literal notranslate"><span class="pre">pip</span></code> can be used (working as of 2020-01-15).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ brew install cunit
$ python3 -m pip install meson --user
$ python3 -m pip install ninja --user
</pre></div>
</div>
<p>On macOS, conda builds are generally done using <code class="docutils literal notranslate"><span class="pre">clang</span></code> packages that are kept up to date:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda install clang_osx-64  clangxx_osx-64
</pre></div>
</div>
<p>In order to make sure that these compilers work correctly (<em>e.g.</em>, so that they can find
other dependencies installed via <code class="docutils literal notranslate"><span class="pre">conda</span></code>), you need to compile <code class="docutils literal notranslate"><span class="pre">msprime</span></code> with this command
on versions of macOS older than “Mojave”:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nv">CONDA_BUILD_SYSROOT</span><span class="o">=</span>/ python3 setup.py build_ext -i
</pre></div>
</div>
<p>On more recent macOS releases, you may omit the <code class="docutils literal notranslate"><span class="pre">CONDA_BUILD_SYSROOT</span></code> prefix.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The use of the C toolchain on macOS is a moving target.  The above advice
was written on 23 January, 2020 and was validated by a few <code class="docutils literal notranslate"><span class="pre">msprime</span></code> contributors.
Caveat emptor, etc..</p>
</div>
</div>
<div class="section" id="compiling">
<h3>Compiling<a class="headerlink" href="#compiling" title="Permalink to this headline">¶</a></h3>
<p>Meson keeps all compiled binaries in a build directory (this has many advantages
such as allowing multiple builds with different options to coexist). It depends on
a <code class="docutils literal notranslate"><span class="pre">meson.build</span></code> file which is in the <code class="docutils literal notranslate"><span class="pre">lib</span></code> directory. To set up the initial build
directory, run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> lib
$ meson build
</pre></div>
</div>
<p>The easiest way to compile the <a class="reference internal" href="#sec-development-c-unit-tests"><span class="std std-ref">Unit Tests</span></a>
is to run <code class="docutils literal notranslate"><span class="pre">ninja</span> <span class="pre">-C</span> <span class="pre">build</span></code>. (Alternatively,
you can <code class="docutils literal notranslate"><span class="pre">cd</span></code> into the <code class="docutils literal notranslate"><span class="pre">build</span></code> directory and run <code class="docutils literal notranslate"><span class="pre">ninja</span></code>). All the
compiled binaries are then in the <code class="docutils literal notranslate"><span class="pre">build</span></code> directory, so to run, for example, the
<code class="docutils literal notranslate"><span class="pre">test_ancestry</span></code> unit tests, use <code class="docutils literal notranslate"><span class="pre">./build/test_ancestry</span></code>. A handy shortcut
to compile the code and run all the unit tests is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ninja -C build <span class="nb">test</span>
</pre></div>
</div>
<p>The <a class="reference external" href="www.vim.org/scripts/script.php?script_id=5378">mesonic</a> plugin for vim
simplifies this process and allows code to be compiled seamlessly within the
editor.</p>
</div>
<div class="section" id="development-cli">
<h3>Development CLI<a class="headerlink" href="#development-cli" title="Permalink to this headline">¶</a></h3>
<p>When developing the C code, it is usually best to use the development CLI to invoke
the code. This is much simpler than going through the Python interface, and allows
tools such as <a class="reference external" href="http://valgrind.org">valgrind</a> to be used directly. For example,
when developing new simulation functionality, you should get the basic work done
using the CLI and only move over to the Python API once you are reasonably sure
that the code works properly.</p>
<p>The development CLI is written using <a class="reference external" href="http://www.hyperrealm.com/libconfig/">libconfig</a> to parse the simulation parameters
file, and <a class="reference external" href="https://github.com/argtable/argtable3">argtable3</a> to parse the
command line arguments. The <code class="docutils literal notranslate"><span class="pre">argtable3</span></code> code is included in the source (but
not used in the distributed binaries, since this is strictly a development
tool). The source code is in <code class="docutils literal notranslate"><span class="pre">dev-tools/dev-cli.c</span></code>.</p>
<p>After building, the CLI is run as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ./build/dev-cli &lt;command&gt; &lt;arguments&gt;
</pre></div>
</div>
<p>Running the <code class="docutils literal notranslate"><span class="pre">dev-cli</span></code> program without arguments will print out a summary of the
options.</p>
<p>The most important command for simulator development is <code class="docutils literal notranslate"><span class="pre">simulate</span></code>,
which takes a configuration file as a parameter and writes the resulting
simulation to an output file in the native <code class="docutils literal notranslate"><span class="pre">.trees</span></code> format. For example,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ./build/dev-cli simulate dev-tools/example.cfg -o out.trees
</pre></div>
</div>
<p>The development configuration file describes the simulation that we want to
run, and uses the
<a class="reference external" href="http://www.hyperrealm.com/libconfig/libconfig_manual.html#Configuration-Files">libconfig syntax</a>.
An example is given in the file <code class="docutils literal notranslate"><span class="pre">dev-tools/example.cfg</span></code> which should have sufficient documentation
to be self-explanatory.</p>
</div>
<div class="section" id="unit-tests">
<span id="sec-development-c-unit-tests"></span><h3>Unit Tests<a class="headerlink" href="#unit-tests" title="Permalink to this headline">¶</a></h3>
<p>The C-library has an extensive suite of unit tests written using
<a class="reference external" href="http://cunit.sourceforge.net">CUnit</a>. These tests aim to establish that the
low-level APIs work correctly over a variety of inputs, and particularly, that
the tests don’t result in leaked memory or illegal memory accesses. The tests should be
periodically run under valgrind to make sure of this.</p>
<p>Tests are defined in the <code class="docutils literal notranslate"><span class="pre">tests</span></code> directory, roughly split into suites
defined in different files. For example, the tests associated with Fenwick
trees are defined in the <code class="docutils literal notranslate"><span class="pre">tests/tests_fenwick.c</span></code> file. To run all the
tests in this suite, use run using <code class="docutils literal notranslate"><span class="pre">./build/test_fenwick</span></code>.
To run a specific test in a particular suite, provide the name of the
test name as a command line argument, e.g.:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ./build/test_fenwick test_fenwick_expand
</pre></div>
</div>
<p>While 100% test coverage is not feasible for C code, we aim to cover all code
that can be reached. (Some classes of error such as malloc failures
and IO errors are difficult to simulate in C.) Code coverage statistics are
automatically tracked using <a class="reference external" href="https://codecov.io/gh/tskit-dev/msprime/">CodeCov</a>.</p>
</div>
<div class="section" id="code-style">
<h3>Code Style<a class="headerlink" href="#code-style" title="Permalink to this headline">¶</a></h3>
<p>C code is formatted using
<a class="reference external" href="https://clang.llvm.org/docs/ClangFormat.html">clang-format</a>
with a custom configuration.
To ensure that your code is correctly formatted, you can run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make clang-format
</pre></div>
</div>
<p>in the project root before submitting a pull request. Alternatively,
you can run <code class="docutils literal notranslate"><span class="pre">clang-format</span> <span class="pre">-i</span> <span class="pre">*.[c,h]</span></code> in the <code class="docutils literal notranslate"><span class="pre">lib</span></code> directory.</p>
<p>Vim users may find the
<a class="reference external" href="https://github.com/rhysd/vim-clang-format">vim-clang-format</a>
plugin useful for automatically formatting code.</p>
</div>
<div class="section" id="coding-conventions">
<h3>Coding conventions<a class="headerlink" href="#coding-conventions" title="Permalink to this headline">¶</a></h3>
<p>The code is written using the <a class="reference external" href="https://en.wikipedia.org/wiki/C99">C99</a> standard. All
variable declarations should be done at the start of a function, and functions
kept short and simple where at all possible.</p>
<p>No global or module level variables are used for production code.</p>
<p>The code is organised following object-oriented principles. Each ‘class’ is defined using
a struct, which encapsulates all the data it requires. Every ‘method’ on this class
is then a function that takes this struct as its first parameter. Each class has
an <code class="docutils literal notranslate"><span class="pre">alloc</span></code> method, which is responsible for allocating memory and a <code class="docutils literal notranslate"><span class="pre">free</span></code> method
which frees all memory used by the object. For example, the
<a class="reference external" href="https://en.wikipedia.org/wiki/Fenwick_tree">Fenwick tree</a> class is defined as
follows:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">log_size</span><span class="p">;</span>
    <span class="kt">double</span> <span class="o">*</span><span class="n">tree</span><span class="p">;</span>
    <span class="kt">double</span> <span class="o">*</span><span class="n">values</span><span class="p">;</span>
<span class="p">}</span> <span class="n">fenwick_t</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">fenwick_alloc</span><span class="p">(</span><span class="n">fenwick_t</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">initial_size</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">fenwick_free</span><span class="p">(</span><span class="n">fenwick_t</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="kt">double</span> <span class="nf">fenwick_get_total</span><span class="p">(</span><span class="n">fenwick_t</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
</pre></div>
</div>
<p>This defines the <code class="docutils literal notranslate"><span class="pre">fenwick_t</span></code> struct, and alloc and free methods and a method
to return the total of the tree. Note that we follow the Python convention
and use <code class="docutils literal notranslate"><span class="pre">self</span></code> to refer to the current instance.</p>
<p>Most objects also provide a <code class="docutils literal notranslate"><span class="pre">print_state</span></code> method, which is useful for
debugging.</p>
<p>Please see the documentation for the <a class="reference external" href="https://tskit.readthedocs.io/en/stable/c-api.html#sec-c-api-overview-structure">tskit C API</a>
for more details on the how APIs are structured.</p>
</div>
<div class="section" id="error-handling">
<h3>Error handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h3>
<p>A critical element of producing reliable C programs is consistent error handling
and checking of return values. All return values <strong>must</strong> be checked! In msprime,
all functions (except the most trivial accessors) return an integer to indicate
success or failure. Any negative value is an error, and must be handled accordingly.
The following pattern is canonical:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">msp_do_something</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">argument</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// rest of function</span>
<span class="nl">out</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</pre></div>
</div>
<p>Here we test the return value of <code class="docutils literal notranslate"><span class="pre">msp_do_something</span></code> and if it is non-zero,
abort the function and return this same value from the current function. This
is a bit like throwing an exception in higher-level languages, but discipline
is required to ensure that the error codes are propagated back to the original
caller correctly.</p>
<p>Particular care must be taken in functions that allocate memory, because
we must ensure that this memory is freed in all possible success and
failure scenarios. The following pattern is used throughout for this purpose:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span>    <span class="kt">double</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">MSP_ERR_NO_MEMORY</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// rest of function</span>
<span class="nl">out</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</pre></div>
</div>
<p>It is vital here that <code class="docutils literal notranslate"><span class="pre">x</span></code> is initialised to <code class="docutils literal notranslate"><span class="pre">NULL</span></code> so that we are guaranteed
correct behaviour in all cases. For this reason, the convention is to declare all
pointer variables on a single line and to initialise them to <code class="docutils literal notranslate"><span class="pre">NULL</span></code> as part
of the declaration.</p>
<p>Error codes are defined in <code class="docutils literal notranslate"><span class="pre">err.h</span></code>, and these can be translated into a
message using <code class="docutils literal notranslate"><span class="pre">msp_strerror(err)</span></code>.</p>
</div>
<div class="section" id="running-valgrind">
<h3>Running valgrind<a class="headerlink" href="#running-valgrind" title="Permalink to this headline">¶</a></h3>
<p>Valgrind is an essential development tool, and is used extensively. (Being able
to run valgrind was one of the motivating factors in the C-library architecture.
It is difficult to run valgrind on a Python extension module, and so the simplest
way to ensure that the low-level code is memory-tight is to separate it out
into an independent library.)</p>
<p>Any new C unit tests that are written should be verified using valgrind to
ensure that no memory is leaked. The entire test suite should be run
through valgrind periodically also to detect any leaks or illegal
memory accesses that have been overlooked.</p>
</div>
</div>
<div class="section" id="python-c-interface">
<h2>Python C Interface<a class="headerlink" href="#python-c-interface" title="Permalink to this headline">¶</a></h2>
<p>The Python C interface is written using the
<a class="reference external" href="https://docs.python.org/3.6/c-api/">Python C API</a> and the code is in the
<code class="docutils literal notranslate"><span class="pre">msprime/_msprimemodule.c</span></code> file. When compiled, this produces the
<code class="docutils literal notranslate"><span class="pre">msprime._msprime</span></code> module,
which is imported by the high-level module. The low-level Python module is
not intended to be used directly and may change arbitrarily over time.</p>
<p>The conventions used within the low-level module here closely follow
those in <code class="docutils literal notranslate"><span class="pre">tskit</span></code>; please see the
<a class="reference external" href="https://tskit.readthedocs.io/en/stable/development.html#python-c-interface">documentation</a>
for more information.</p>
</div>
<div class="section" id="statistical-tests">
<h2>Statistical tests<a class="headerlink" href="#statistical-tests" title="Permalink to this headline">¶</a></h2>
<p>To ensure that <code class="docutils literal notranslate"><span class="pre">msprime</span></code> is simulating the correct process we run many statistical
tests. Since these tests are quite expensive (taking some hours to run) and
difficult to automatically validate, they are not run as part of CI but instead
as a pre-release sanity check. They are also very useful to run when developing
new simulation functionality, as subtle statistical bugs can easily slip in
unnoticed.</p>
<p>The statistical tests are all run via the <code class="docutils literal notranslate"><span class="pre">verification.py</span></code> script in the project root.
The script has some extra dependencies listed in the <code class="docutils literal notranslate"><span class="pre">requirements/verification.txt</span></code>,
which can be installed using <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-r</span></code> or <code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">install</span> <span class="pre">--file</span></code>. Run
this script using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python3 verification.py
</pre></div>
</div>
<p>The statistical tests depend on compiled programs in the <code class="docutils literal notranslate"><span class="pre">data</span></code> directory.
This includes a customised version of <code class="docutils literal notranslate"><span class="pre">ms</span></code> and a locally compiled version of
<a class="reference external" href="https://scrm.github.io/">scrm</a>. These programs must be compiled before
running the statistical tests, and can be built by running <code class="docutils literal notranslate"><span class="pre">make</span></code> in the
<code class="docutils literal notranslate"><span class="pre">data</span></code> directory. If this is successful, there should be several binaries
like <code class="docutils literal notranslate"><span class="pre">ms</span></code> and <code class="docutils literal notranslate"><span class="pre">ms_summary_stats</span></code> present in the <code class="docutils literal notranslate"><span class="pre">data</span></code>
directory.</p>
<p>Please the comments at the top of the <code class="docutils literal notranslate"><span class="pre">verification.py</span></code> script for details
on how to write and run these tests.</p>
</div>
<div class="section" id="benchmarking">
<h2>Benchmarking<a class="headerlink" href="#benchmarking" title="Permalink to this headline">¶</a></h2>
<p>Benchmarks to measure performance are in the <code class="docutils literal notranslate"><span class="pre">benchmarks</span></code> folder and are run using
<a class="reference external" href="https://asv.readthedocs.io/en/stable/index.html">airspeed velocity</a>.
An automated system runs the benchmarks on each push to the main branch and uploads
the results to <cite>this github pages site</cite> &lt;<a class="reference external" href="https://tskit-dev.github.io/msprime-asv">https://tskit-dev.github.io/msprime-asv</a>&gt;_.
These benchmarks can also be run locally to compare your branch with the main branch.
Your changes must be in a commit to be measured. To run the benchmarks:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">asv</span> <span class="n">run</span> <span class="n">asv</span> <span class="n">run</span> <span class="n">HEAD</span><span class="o">...</span><span class="n">main</span><span class="o">~</span><span class="mi">1</span>
</pre></div>
</div>
<p>This will run the benchmarks for the latest main branch commit and all commits on
your current branch (the syntax for choosing commits is the same as <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">log</span></code>).
The following commands then make a browsable report (link given in output of
the command):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">asv</span> <span class="n">publish</span>
<span class="n">asv</span> <span class="n">preview</span>
</pre></div>
</div>
<p>Note the following tips:</p>
<ul class="simple">
<li><p>Specifying the range of commits to run uses the same syntax as git log.
For example, to run for a single commit, use <code class="docutils literal notranslate"><span class="pre">asv</span> <span class="pre">run</span> <span class="pre">88fbbc33^!</span></code></p></li>
<li><p>Be careful when running <code class="docutils literal notranslate"><span class="pre">asv</span> <span class="pre">dev</span></code> or using <code class="docutils literal notranslate"><span class="pre">python=same</span></code> as
this can use the <em>installed</em> version of msprime rather than the local
development version. This can lead to confusing results! When tuning
benchmarks it’s better to commit often and use (e.g.)
<code class="docutils literal notranslate"><span class="pre">asv</span> <span class="pre">run</span> <span class="pre">HEAD^!</span> <span class="pre">--show-stderr</span> <span class="pre">-b</span> <span class="pre">Hudson.time_large_sample_size</span></code>.</p></li>
</ul>
</div>
<div class="section" id="containerization">
<h2>Containerization<a class="headerlink" href="#containerization" title="Permalink to this headline">¶</a></h2>
<p>To run msprime in a container, see the
<a class="reference internal" href="installation.html#sec-linux-container"><span class="std std-ref">installation instructions as Linux container</span></a>.</p>
<p>You can use <code class="docutils literal notranslate"><span class="pre">docker</span></code> to locally build an image, but it requires root access:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo docker build -t tskit/msprime .
</pre></div>
</div>
<p><a class="reference external" href="https://podman.io/">podman</a> can build and run images without root privilege.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ podman build -t tskit/msprime .
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h2>Documentation<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>Documentation is written using <a class="reference external" href="http://www.sphinx-doc.org/en/stable/">Sphinx</a>
and contained in the <code class="docutils literal notranslate"><span class="pre">docs</span></code> directory. It is written in the
<a class="reference external" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> format and
is deployed automatically to <a class="reference external" href="https://readthedocs.org/">readthedocs</a>. To
build the documentation locally run <code class="docutils literal notranslate"><span class="pre">make</span></code> in the <code class="docutils literal notranslate"><span class="pre">docs</span></code> directory.
This should build the HTML documentation in <code class="docutils literal notranslate"><span class="pre">docs/_build/html/</span></code>.</p>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">make</span></code> is giving you strange errors, or if tests are failing for
strange reasons, try running <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code> in the project root
and then rebuilding.</p></li>
<li><p>Beware of multiple versions of the python library installed by different
programs (e.g., pip versus installing locally from source)! In python,
<code class="docutils literal notranslate"><span class="pre">msprime.__file__</span></code> will tell you the location of the package that is being
used.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="CITATION.html" class="btn btn-neutral float-right" title="Citing msprime" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="cli.html" class="btn btn-neutral float-left" title="Command line interface" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2015-2020, Tskit Developers

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>